DrawEngine=Class.extend({ctx:null,font:{align:"center",size:"40px",style:"bold",family:"Helvetica, Arial, sans-serif"},init:function(a){this.ctx=a},drawImage:function(c,a,e,b,d){this.ctx.drawImage(gSpriteSheet.img,gSpriteSheet.sprites[c].x,gSpriteSheet.sprites[c].y,gSpriteSheet.sprites[c].w,gSpriteSheet.sprites[c].h,Math.floor(a-(b>>1)),Math.floor(e-(d>>1)),b,d)},drawText:function(a,e,d,c){var b=this.font;if(c){b=c}this.ctx.textAlign=b.align;this.ctx.font=b.style+" "+b.size+" "+b.family;this.ctx.fillStyle="";this.ctx.fillText(d,a,e)},clear:function(){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}});Entity=Class.extend({pos:{x:0,y:0},size:{h:0,w:0},sprite:"",zindex:0,init:function(d,a,f,b,e,c){this.sprite=d;this.pos={};this.pos.x=a;this.pos.y=f;this.size={};this.size.w=b;this.size.h=e;this.zindex=c},move:function(){},onTouch:function(){}});Vec2=Box2D.Common.Math.b2Vec2;BodyDef=Box2D.Dynamics.b2BodyDef;Body=Box2D.Dynamics.b2Body;FixtureDef=Box2D.Dynamics.b2FixtureDef;Fixture=Box2D.Dynamics.b2Fixture;World=Box2D.Dynamics.b2World;MassData=Box2D.Collision.Shapes.b2MassData;PolygonShape=Box2D.Collision.Shapes.b2PolygonShape;CircleShape=Box2D.Collision.Shapes.b2CircleShape;DebugDraw=Box2D.Dynamics.b2DebugDraw;RevoluteJointDef=Box2D.Dynamics.Joints.b2RevoluteJointDef;PrismaticJointDef=Box2D.Dynamics.Joints.b2PrismaticJointDef;PhysicsEngine=Class.extend({walls:[],world:null,PHYSICS_LOOP_HZ:1/60,init:function(){},create:function(){gPhysicsEngine.world=new World(new Vec2(0,0),true);var a=new BodyDef(),b=new FixtureDef();b.density=1;b.friction=1;b.restitution=1;a.type=Body.b2_staticBody;a.position.Set(0,720);b.shape=new PolygonShape;b.shape.SetAsEdge(new Vec2(0,0),new Vec2(960,0));this.walls.floor=this.world.CreateBody(a).CreateFixture(b);a.position.Set(0,0);this.walls.ceil=this.world.CreateBody(a).CreateFixture(b);a.position.Set(0,0);b.shape=new PolygonShape;b.shape.SetAsEdge(new Vec2(0,0),new Vec2(0,720));this.walls.left=this.world.CreateBody(a).CreateFixture(b);a.position.Set(960,0);b.shape.SetAsEdge(new Vec2(0,0),new Vec2(0,720));this.walls.right=this.world.CreateBody(a).CreateFixture(b)},update:function(){var a=Date.now();gPhysicsEngine.world.Step(gPhysicsEngine.PHYSICS_LOOP_HZ,10,10);gPhysicsEngine.world.ClearForces();return(Date.now()-a)},addContactListener:function(a){var b=new Box2D.Dynamics.b2ContactListener();if(a.PostSolve){b.PostSolve=function(c,d){a.PostSolve(c,c.GetFixtureA().GetBody(),c.GetFixtureB().GetBody(),d)}}gPhysicsEngine.world.SetContactListener(b)},registerBody:function(b){var a=gPhysicsEngine.world.CreateBody(b);return a},addBody:function(e){var c=new BodyDef();if(e.type==="static"){c.type=Body.b2_staticBody}else{c.type=Body.b2_dynamicBody}c.position.x=e.x;c.position.y=e.y;if(e.userData){c.userData=e.userData}var a=this.registerBody(c);var d=new FixtureDef();d.density=2;d.friction=0;d.restitution=1;if(e.shape!=="circle"){var b=new PrismaticJointDef();d.density=5;d.friction=1;d.shape=new PolygonShape();d.shape.SetAsBox(e.halfWidth,e.halfHeight);b.bodyA=a;b.bodyB=this.walls[c.userData.pos].GetBody();b.collideConnected=false;b.localAxisA.Set(0,1);if(c.userData.pos==="left"){b.localAnchorA.Set(-50,0)}else{b.localAnchorA.Set(50,0)}b.enableMotor=true;b.maxMotorForce=2;this.world.CreateJoint(b)}else{d.shape=new CircleShape(e.halfWidth)}a.CreateFixture(d);return a},removeBody:function(a){gPhysicsEngine.world.DestroyBody(a)}});var gPhysicsEngine=new PhysicsEngine();Scene=Class.extend({drawEngine:null,entities:[],init:function(a){this.drawEngine=a},update:function(){var a=this;this.drawEngine.clear();this.entities.forEach(function(b){a.drawEngine.drawImage(b.sprite,b.pos.x,b.pos.y,b.size.w,b.size.h)})}});SpriteSheet=Class.extend({img:null,sprites:[],init:function(){},load:function(a,c){var b=new XMLHttpRequest();b.open("GET",a,true);b.onload=function(){var d;try{d=JSON.parse(this.responseText)}catch(f){alert("Spritesheet JSON file it's not in this directory")}gSpriteSheet.parseSprites(d,c)};b.send()},parseSprites:function(b,h){var c=false,f=false,a=new Image();a.onload=function(){c=true;if(f){h()}};a.src=b.meta.image;this.img=a;for(var e in b.frames){var g=b.frames[e],d={x:g.frame.x,y:g.frame.y,w:g.frame.w,h:g.frame.h,cx:-g.frame.w*0.5,cy:-g.frame.h*0.5};if(g.trimmed){d.cx=g.spriteSourceSize.x-(g.sourceSize.w*0.5);d.cy=g.spriteSourceSize.y-(g.sourceSize.h*0.5)}gSpriteSheet.sprites[e]=d}f=true;if(c){h()}}});var gSpriteSheet=new SpriteSheet();Collisionable=Entity.extend({dir:{x:0,y:0},physBody:null,speed:0,init:function(e,a,i,b,f,d,c,g){this._super(e,a,i,b,f,d);this.dir=c;this.speed=g}});Interface=Entity.extend({init:function(d,a,f,b,e,c){this._super(d,a,f,b,e,c)}});Ball=Collisionable.extend({init:function(a,g,b,d){var c=this.initDir(),f={},e=1800;this._super("bola.png",a,g,b,d,10,c,e);f={shape:"circle",x:a,y:g,halfWidth:(b>>1),halfHeight:(d>>1),type:"dynamic",userData:{ent:this}};this.physBody=gPhysicsEngine.addBody(f);this.physBody.SetLinearVelocity(new Vec2(c.x*e,c.y*e))},initDir:function(){return{x:1,y:(Math.random()*2)-1}},restart:function(b,a){this.pos=b;this.physBody.SetPosition(this.pos);this.dir=a},move:function(){if(this.physBody!==null){var a=this.physBody.GetPosition();this.pos.x=a.x;this.pos.y=a.y}},onTouch:function(b,a,c){}});Paddle=Collisionable.extend({ball:null,maxSpeed:10,init:function(b,a,i,c,e,f){var d=(b==="left")?"pala1.png":"pala2.png",g;this._super(d,a,i,c,e,10,{x:0,y:0},0);this.ball=f;g={shape:"box",x:a,y:i,halfWidth:(c>>1),halfHeight:(e>>1),type:"dynamic",userData:{ent:this,pos:b}};this.physBody=gPhysicsEngine.addBody(g);this.physBody.SetLinearVelocity(new Vec2(0,0))},followBall:function(){if(this.ball){if((this.pos.y>this.ball.pos.y)&&this.pos.y>(this.size.h>>1)&&(this.speed>-this.maxSpeed)){this.speed--}else{if(this.pos.y<this.ball.pos.y&&this.pos.y<(720-(this.size.h>>1))&&(this.speed<this.maxSpeed)){this.speed++}else{if(this.speed!==0){this.speed+=(this.speed>0)?-1:1}}}}},move:function(){this.followBall();if(this.physBody!==null){var a=this.physBody.GetPosition();this.pos.x=a.x;if(((a.y+this.speed)>((this.size.h>>1)-this.maxSpeed))&&((a.y+this.speed)<(720-(this.size.h>>1)+this.maxSpeed))){this.pos.y=a.y+this.speed}this.physBody.SetPosition(this.pos)}}});Player=Paddle.extend({bindings:{},actions:{},init:function(a,e,b,d){this._super("left",a,e,b,d);var c=this;this.bind(87,"move-up");this.bind(38,"move-up");this.bind(83,"move-down");this.bind(40,"move-down");document.addEventListener("keydown",function(f){c.onKeyDown(f)});document.addEventListener("keyup",function(f){c.onKeyUp(f)})},onKeyDown:function(a){var b=this.bindings[a.keyCode];if(b){this.actions[b]=true}},onKeyUp:function(a){var b=this.bindings[a.keyCode];if(b){this.actions[b]=false}},bind:function(a,b){this.bindings[a]=b},move:function(){if(this.actions["move-up"]&&this.pos.y>(this.size.h>>1)&&(this.speed>-this.maxSpeed)){this.speed--}else{if(this.actions["move-down"]&&this.pos.y<(720-(this.size.h>>1))&&(this.speed<this.maxSpeed)){this.speed++}else{if(this.speed!==0){this.speed+=(this.speed>0)?-1:1}}}this._super()}});Scoreboard=Interface.extend({init:function(c,a,d){var b=c+".png";this._super(b,a,d,gSpriteSheet.sprites[b].w,gSpriteSheet.sprites[b].h,0)},changeValue:function(a){this.sprite=a+".png"}});GameScene=Scene.extend({audio:null,ball:null,score:{p1:0,p2:0},scoreBoards:[],init:function(b){this._super(b);var a=this;require(["src/entities/Ball.js?v="+version+"","src/entities/Paddle.js?v="+version+"","src/interfaces/Scoreboard.js?v="+version+"","src/entities/Player.js?v="+version+""],function(){var c=60,e=340,g,f,d;gPhysicsEngine.create();a.ball=new Ball(480,360,34,34);f=new Player(50,360,38,182);d=new Paddle("right",910,360,38,182,a.ball);a.entities.push(a.ball);a.entities.push(f);a.entities.push(d);a.scoreBoards.push(new Scoreboard(0,e,c));a.scoreBoards.push(new Scoreboard(0,e+80,c));a.scoreBoards.push(new Scoreboard(0,e+200,c));a.scoreBoards.push(new Scoreboard(0,e+280,c));a.scoreBoards.forEach(function(h){a.entities.push(h)});gPhysicsEngine.addContactListener({PostSolve:function(h,m,l,k){var j=m.GetUserData();var i=l.GetUserData();if(j&&j.ent){j.ent.onTouch(h,l,k)}if(i&&i.ent){i.ent.onTouch(h,m,k)}}})})},checkScore:function(){var a=this.ball;if(a){if(a.pos.x<=(a.size.w)){a.restart({x:480,y:360},a.initDir());this.score.p2++}else{if(a.pos.x>=(960-(a.size.w))){a.restart({x:480,y:360},a.initDir());this.score.p1++}else{return false}}this.updateScore();return true}return false},updateScore:function(){this.scoreBoards[0].changeValue(Math.floor(this.score.p1/10));this.scoreBoards[1].changeValue(Math.floor(this.score.p1%10));this.scoreBoards[2].changeValue(Math.floor(this.score.p2/10));this.scoreBoards[3].changeValue(Math.floor(this.score.p2%10))},update:function(){this.checkScore();if(gPhysicsEngine.world){gPhysicsEngine.update()}this.entities.forEach(function(a){a.move()});this._super()}});LoadingScene=Scene.extend({init:function(a){this._super(a)},update:function(){this._super();this.drawEngine.drawText(350,281,"Loading...")}});MainScene=Scene.extend({});Game=Class.extend({baseUrl:"",canvas:null,drawEngine:null,fps:30,scene:null,size:{w:0,h:0},init:function(a,b){this.baseUrl=b;this.canvas=a;this.size.w=a.width;this.size.h=a.height},start:function(){var a=this;require(["src/core/DrawEngine.js?v="+version+"","src/core/Entity.js?v="+version+"","src/core/Scene.js?v="+version+"","src/core/SpriteSheet.js?=v"+version+"","src/core/PhysicsEngine.js?v="+version+""],function(){require(["src/scenes/LoadingScene.js?v="+version+"","src/scenes/GameScene.js?v="+version+"","src/entities/base/Collisionable.js?v="+version+"","src/entities/base/Interface.js?v="+version+""],function(){a.drawEngine=new DrawEngine(a.canvas.getContext("2d"));a.scene=new LoadingScene(a.drawEngine);setTimeout(function(){a.update()},1000/a.fps);gSpriteSheet.load("assets/textures/spreadsheet.json",function(){a.scene=new GameScene(a.drawEngine)})})})},update:function(){var a=this;a.scene.update();setTimeout(function(){a.update()},1000/a.fps)}});